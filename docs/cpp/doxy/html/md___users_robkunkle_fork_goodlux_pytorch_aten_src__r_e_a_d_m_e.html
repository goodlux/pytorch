<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: README</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">README </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This directory contains the low-level tensor libraries for PyTorch, as well as the new ATen C++ bindings.</p>
<p>The low-level libraries trace their lineage from the original Torch. There are multiple variants of the library, summarized here:</p>
<ul>
<li>TH = TorcH</li>
<li>THC = TorcH Cuda</li>
<li>THCS = TorcH Cuda Sparse (now defunct)</li>
<li>THCUNN = TorcH CUda Neural Network (see cunn)</li>
<li>THD = TorcH Distributed</li>
<li>THNN = TorcH Neural Network</li>
<li>THS = TorcH Sparse (now defunct)</li>
</ul>
<p>(You'll also see these abbreviations show up in symbol names.)</p>
<h2>Reference counting</h2>
<p>PyTorch employs reference counting in order to permit tensors to provide differing views on a common underlying storage. For example, when you call view() on a Tensor, a new THTensor is allocated with differing dimensions, but it shares the same THStorage with the original tensor.</p>
<p>Unfortunately, this means we are in the business of manually tracking reference counts inside our C library code. Fortunately, for most of our library code implementing tensor operations, there is only one rule you have to remember:</p>
<blockquote class="doxtable">
<p><b>Golden Rule of Reference Counting:</b> You must either FREE or RETURN a pointer which was returned by a function whose name begins with <code>new</code> or which you called <code>retain</code> on. If you return this pointer, your function name must begin with <code>new</code>. </p>
</blockquote>
<p>In a long function, there may be many invocations of functions with <code>new</code> in their name. Your responsibility is to go through each of them and ensure that there is a matching <code>free</code> for it for EACH exit point of the function.</p>
<h3>Examples</h3>
<p>Suppose you want to get a reference to the indices of a sparse tensor. This function is called <code>newIndices</code>. The <code>new</code> means you MUST free it when you're done (usually at the end of your function.) (It's worth noting that <code>newIndices</code> doesn't actually allocate a fresh indices tensor; it just gives you a pointer to the existing one.) DO NOT directly access the member variables of the struct.</p>
<div class="fragment"><div class="line">THIndexTensor *indices = THSTensor_(newIndices)(state, sparse);</div><div class="line">// ... do some stuff ...</div><div class="line">THIndexTensor_(free)(state, indices);</div></div><!-- fragment --><p>Let's take a look at the implementation of <code>newIndices</code>. This doesn't free the return result of <code>newNarrow</code>, but returns it. This justifies the <code>new</code> in its name.</p>
<div class="fragment"><div class="line">THIndexTensor *THSTensor_(newIndices)(const THSTensor *self) {</div><div class="line">  // ...</div><div class="line">  return THIndexTensor_(newNarrow)(self-&gt;indices, 1, 0, self-&gt;nnz);</div><div class="line">}</div></div><!-- fragment --><p>Passing an object to another function does NOT absolve you of responsibility of freeing it. If that function holds on to a pointer to the object, it will <code>retain</code> it itself.</p>
<div class="fragment"><div class="line">THLongStorage *inferred_size = THLongStorage_newInferSize(size, numel);</div><div class="line">THTensor_(setStorage)(self, tensor-&gt;storage, tensor-&gt;storageOffset, inferred_size, NULL);</div><div class="line">THLongStorage_free(inferred_size);</div></div><!-- fragment --><p>Sometimes, you have a tensor in hand which you'd like to use directly, but under some conditions you have to have to call, e.g., <code>newContiguous</code>, to get it into the correct form:</p>
<div class="fragment"><div class="line">if (!(k_-&gt;stride(3) == 1) || !(k_-&gt;stride[2] == k_-&gt;size(3))) {</div><div class="line">  kernel = THTensor_(newContiguous)(k_);</div><div class="line">} else {</div><div class="line">  THTensor_(retain)(k_);</div><div class="line">  kernel = k_;</div><div class="line">}</div><div class="line">...</div><div class="line">THTensor_(free)(kernel);</div></div><!-- fragment --><p>In this case, we have (redundantly) called <code>retain</code> on <code>k_</code>, so that we can unconditionally free <code>kernel</code> at the end of the function; intuitively, you want it to be possible to replace the conditional expression with an equivalent function call, e.g., <code>kernel = THTensor_(newContiguous2D)(k_)</code>.</p>
<h3>Tips</h3>
<ul>
<li>If you have an early exit in a function (via a <code>return</code>), don't forget to <code>free</code> any pointers which you allocated up to this point. If at all possible, move early exits prior to these allocations, so that you don't have to clean up.</li>
<li>Very occasionally, you may be able to implement an algorithm more efficiently if you "destroy" its input. This is a <code>move</code>; after moving an object away, you must NOT <code>free</code> it. This is the one exception to the rule, and at the moment there is only one instance of <code>move</code> in the code base.</li>
<li>We use <code>THError</code> to signal error cases, and fortunately, you do NOT need to make sure you've freed everything before calling <code>THError</code>, because by default, it aborts the entire process. However, it's good style to call <code>THError</code> before performing any allocations, since in some cases we sketchily throw a C++ exception and try to recover (in particular, the test suite does this.)</li>
</ul>
<h2>The C interface</h2>
<p>Historically, the Torch libraries were implemented in C. Since then, we have slowly started rewriting bits of pieces of Torch in C++ (usually because there is some C++ feature which would be really helpful for writing something.) However, Torch has <em>always been</em>, and <em>will always be</em> a library that provides a C ABI interface, even if, at some point in the future, its internal implementation is entirely done in a C++ library that heavily uses C++ idioms. (At the moment, all of the source files are C++, but they are mostly C code that happens to be compiled as C++).</p>
<p>In order to achieve this, the <code>TH_API</code> macro (called <code>THC_API</code> in <code>THC</code>) plays a crucial role: it declares a function as having C-linkage, which means that the C++ compiler doesn't mangle its name and a C client can link against it.</p>
<p>As a developer, here is what you need to know:</p>
<ol type="1">
<li>If you add a function to the public API of Torch, you <em>must</em> mark it with <code>TH_API</code> or <code>THC_API</code> (depending if you are in CPU or CUDA land). This will ensure it is built with C-linkage (and on Windows, it will also ensure that the symbol is exported from the DLL; otherwise it won't be visible.)</li>
<li>C++ features should ONLY be used in <code>.cpp</code> and <code>.hpp</code> files, and not in <code>.h</code> files. If you need to use a C++ type in a header file, you should define this in a separate, C++ only header <code>.hpp</code>, and declare it opaquely in the <code>.h</code>. Search for <code>mutex</code> for an example of this principle being applied. (This convention is OPPOSITE from the prevailing convention in PyTorch and ATen, where C++ headers are defined in <code>.h</code> files.)</li>
</ol>
<p>Arguably, the "C-compatible" headers should live in a separate directory, distinct from the C++ code. We think this might be a good thing to do eventually, and would make the code structure more clear, but we have not done it at the moment. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
